# 📋 약관 자동 생성 프로그램 (Insurance Terms AutoGen)

> **VBA Excel 매크로 → Python 변환 버전**  
> 보험 상품 약관 문서를 자동으로 생성하는 프로그램입니다.

---

## 📌 프로그램 목적

이 프로그램은 보험 상품의 특별약관 문서를 자동으로 생성합니다.

### 주요 기능
1. **담보 매핑 체크** - PGM의 담보코드와 대표담보코드 매핑 확인
2. **약관 생성** - Base 약관 파일에서 개별 담보별 약관을 복사하고 태그 치환
3. **별표 수정** - 상품/독립특약 내 별표 내용 수정
4. **태그 처리** - 모델링 속성값에 따른 조건부 문구 치환/삭제

---

## 🔄 프로그램 실행 흐름

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           📁 Step 1: 파일 불러오기                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   [파일 불러오기 버튼] ──┬──> [입력 템플릿 Excel 열기]                        │
│                         │                                                    │
│                         └──> [CSV 매핑 파일 자동 로드]                        │
│                                      │                                       │
│                                      ▼                                       │
│              ┌────────────┬────────────────┬────────────────┐               │
│              │ 상품속성   │   경로설정     │   담보목록     │               │
│              │   입력     │     입력       │     입력       │               │
│              └─────┬──────┴───────┬────────┴───────┬────────┘               │
│                    └──────────────┼────────────────┘                        │
│                                   ▼                                          │
│                        [Excel 저장 (Ctrl+S)]                                 │
│                                   │                                          │
│                                   ▼                                          │
│                     [템플릿 데이터 새로고침 클릭]                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         🔍 Step 2: 담보 매핑 체크                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   [PGM에서 담보코드 추출] ──> [CSV 매핑 테이블 조회] ──> [매핑 결과 확인]     │
│                                                                              │
│      Input: ExcelPGM              Process: 담보매핑.csv       Output: 대표담보코드  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           📝 Step 3: 약관 생성                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│   │ 1.PGM 읽기  │───>│ 2.약관 복사 │───>│ 3.태그 처리 │───>│ 4.문서 저장 │  │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│         │                  │                  │                  │          │
│         ▼                  ▼                  ▼                  ▼          │
│   담보구조/보장배수   약관Base에서      치환태그+         출력약관경로에     │
│   보기납기 로드       담보 구간 복사    출력조정태그      타임스탬프 저장    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              📤 Output                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   저장 위치: 출력약관경로/{원본파일명}_{YYYYMMDD}_{HHMMSS}.docx               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Step 1: 파일 불러오기

| 순서 | 작업 | 설명 |
|:----:|------|------|
| 1 | 파일 불러오기 클릭 | 입력 템플릿 Excel 자동 열림 |
| 2 | CSV 자동 로드 | `data/` 폴더의 담보매핑.csv, 참조.csv |
| 3 | Excel 입력 | 상품속성, 경로설정, 담보목록 작성 |
| 4 | Excel 저장 | Ctrl+S로 저장 |
| 5 | 새로고침 클릭 | 템플릿 데이터 로드 |

### Step 2: 담보 매핑 체크

| 입력 | 처리 | 출력 |
|------|------|------|
| ExcelPGM → 담보코드 | CSV 매핑 테이블 조회 | 대표담보코드, 구분값 |

### Step 3: 약관 생성 (PrintDambo)

| 단계 | 작업 | 설명 |
|:----:|------|------|
| 1 | PGM 읽기 | 담보구조, 보장배수, 보기납기 데이터 로드 |
| 2 | 약관 복사 | 약관Base에서 담보 구간 → 상품약관으로 복사 |
| 3 | 태그 처리 | 치환태그 + 출력조정태그 일괄 처리 |
| 4 | 문서 저장 | 출력약관경로/{원본}_{시간}.docx |

---

## 📥 Input (입력 파일)

### 1. 입력 템플릿 Excel (`templates/입력템플릿.xlsx`)

프로그램 실행에 필요한 모든 정보를 입력하는 Excel 파일입니다.

#### 경로설정 시트 (첫 번째 탭)
| 항목 | 설명 | 예시 |
|------|------|------|
| 약관Base 폴더경로 | 약관Base 파일들이 있는 폴더 (여러 경로는 `;`로 구분) | `C:\약관Base\` |
| ExcelPGM 파일경로 | ExcelPGM 파일 전체 경로 | `C:\PGM\상품_PGM.xlsm` |
| 상품약관 파일경로 | 상품약관 파일 전체 경로 | `C:\약관\상품약관.docx` |
| 출력약관 폴더경로 | 결과 약관이 저장될 폴더 경로 | `C:\약관출력\` |

#### 상품속성 시트
| 속성명 | 값 | 설명 |
|--------|-----|------|
| 상품코드 | 텍스트 | 예: P001 |
| 상품명 | 텍스트 | 예: 무배당 건강보험 |
| 자동갱신형 | 0/1 | 갱신형 여부 |
| 단체보험 | 0/1 | 단체보험 여부 |
| 모듈형 | 0/1 | 모듈형 상품 여부 |
| 독립특약 | 0/1 | 독립특약 여부 |
| 중증간편 | 0/1 | 중증간편 상품 여부 |
| 0세자녀 | 0/1 | 0세자녀 특약 포함 여부 |

#### 담보목록 시트

**색상 구분**: 🟠 사용자 입력 | 🟢 PGM 참조값 | 🔵 매핑 결과

| 컬럼 | 구분 | 설명 |
|------|------|------|
| 순번 | 자동 | 자동 번호 |
| **담보코드** | 🟠 사용자입력 | PGM의 담보코드 |
| **담보명** | 🟠 사용자입력 | 담보 명칭 |
| **출력담보명** | 🟠 사용자입력 | 약관에 표시될 이름 |
| **진단확정** | 🟠 사용자입력 | 0/1 |
| **부모** | 🟠 사용자입력 | 0/1 |
| **예약가입연령** | 🟠 사용자입력 | 0/1 |
| **모듈** | 🟠 사용자입력 | 0/1 |
| 면책 | 🟢 PGM참조 | 담보매핑 시 PGM에서 자동 채움 |
| 감액 | 🟢 PGM참조 | 담보매핑 시 PGM에서 자동 채움 |
| 연장형 | 🟢 PGM참조 | 담보매핑 시 PGM에서 자동 채움 |
| 대표담보코드 | 🔵 매핑결과 | 담보매핑 시 CSV에서 자동 채움 |
| 구분값 | 🔵 매핑결과 | 상해/질병/상해질병 등 |
| 확인필요 | 🔵 매핑결과 | 에러 표시 (자동) |

### 2. 약관Base Word 파일 (약관Base디렉토리)

**7가지 타입**의 약관Base 파일을 지원합니다. 파일명에 키워드가 포함되면 **자동으로 타입이 분류**됩니다.

| 타입 | 키워드 | 예시 파일명 |
|------|--------|-------------|
| 상해 | `상해` | `약관Base_상해.docx` |
| 질병 | `질병` | `약관Base_질병.docx` |
| 상해질병 | `상해질병` | `약관Base_상해질병.docx` |
| 비용배상책임 | `비용배상책임` | `약관Base_비용배상책임.docx` |
| 펫 | `펫` | `약관Base_펫.docx` |
| 태아 | `태아` | `약관Base_태아.docx` |
| 부양자 | `부양자` | `약관Base_부양자.docx` |

> **⚠️ 주의**: 지정 디렉토리 내 모든 Word 파일이 자동으로 검색됩니다.

#### 약관Base 파일 구조
- **고정출력영역**: 모든 담보에 공통 적용되는 문구
- **가변출력영역**: 태그로 조건부 출력 제어
- **메모**: 약관 제목에 대표담보코드 기재 (예: `ZD123456,ZD654321`)

### 3. ExcelPGM 파일 (ExcelPGM경로)

상품 모델링 데이터가 포함된 Excel 매크로 파일입니다.

| 시트명 | 내용 |
|--------|------|
| Main_{상품코드} | 담보 목록 및 상품 속성 |
| 1.보기납기 | 보험기간/납입기간 조합 |
| 2.보장구조 | 세부담보 구조 정보 |
| 3.보장배수 | 지급률, 면책/감액 기간 |

### 4. 상품약관 Word 파일 (상품약관경로)

- 프로그램 실행의 **기반이 되는** 파일입니다.
- 원본 파일은 수정되지 않으며, **출력약관경로**에 복사본이 저장됩니다.
- 저장 파일명: `{원본파일명}_{날짜}_{시간}.docx`

### 5. CSV 매핑 파일 (data/ 폴더)

#### 담보매핑.csv
```csv
대표담보코드,대표담보명(약관),담보코드,담보명,구분
ZD0021010,유사암 최초수술비,ZD0021010,유사암 최초수술비,질병
```

#### 참조.csv
```csv
담보속성,코드명,적용구분,약관문구,비고
단체,{단체1},1,해당 피보험자에 대하여,
감액,{감액1},1,보험료증권에 감액기간...,
진단확정,{진단확정1},1,(으)로 진단확정되고,
```

---

## 📤 Output (출력 파일)

### 생성되는 Word 문서

```
{상품약관파일명}_{날짜}_{시간}.docx
```

**예시**: `상품약관_건강보험_20260203_153000.docx`

### 처리 결과
- 약관Base에서 해당 담보 약관 섹션 복사
- 담보속성에 따른 태그 치환 완료
- 조항번호 자동 조정
- 메모 영역 → 사용자 정의 약관명으로 변경

---

## 🏷️ 태그 처리 규칙

### 치환태그 (Substitution Tags)

| 태그 | 설명 | 치환 소스 |
|------|------|-----------|
| `{단체N}` | 단체보험 관련 문구 | 참조시트 |
| `{감액N}` | 감액 관련 문구 | 참조시트 |
| `{감액2-N}` | N번째 담보의 감액 문구 | 참조시트 |
| `{연장형}` | 연장형 관련 문구 | 참조시트 |
| `{부모}` | 부모 담보 관련 문구 | 참조시트 |
| `{예약가입}` | 예약가입연령 관련 | 참조시트 |
| `{진단확정N}` | 진단확정 관련 문구 | 참조시트 |
| `{세부보장N}` | N번째 세부보장명 | 메인시트 |
| `{감액기간N-K}` | N번째 담보의 K번째 감액기간 | PGM |
| `{지급률N-M-K}` | 지급률 (체증형 계산 지원) | PGM |

### 적용구분 규칙 (참조시트)
- **적용구분 = 1**: 해당 속성이 있는 경우 치환
- **적용구분 = 0**: 해당 속성이 없는 경우 치환
- **정의 없음**: 태그 삭제

### 출력조정태그 (Output Control Tags)

| 태그 | 규칙 |
|------|------|
| `{면책0-1}` ~ `{면책0-2}` | 면책 있으면 태그만 삭제, 없으면 전체 삭제 |
| `{면책0-3}` ~ `{면책0-4}` | 면책 있으면 전체 삭제, 없으면 태그만 삭제 |
| `{감액있음N-K}` | 감액 있으면 태그만 삭제 (K=1,2), 전체 삭제 (K=3,4) |
| `{진단확정N-K}` | 진단확정 여부에 따라 처리 |
| `{자동갱신형N-K}` | 갱신형 여부에 따라 처리 |
| `{독립특약0-K}` | 독립특약 여부에 따라 처리 |

> **K 값 규칙**  
> - **K=1,2**: 속성 해당 → 태그만 삭제 / 비해당 → 태그+내용 삭제  
> - **K=3,4**: 속성 해당 → 태그+내용 삭제 / 비해당 → 태그만 삭제

---

## ⚡ 예상 실행 시간 (Performance)

### 벤치마크 (담보 100개 기준)

| 단계 | 예상 시간 | 최적화 기법 |
|------|----------|-------------|
| 설정 파일 로드 | 1-3초 | Pandas bulk read |
| CSV 로드 | < 1초 | 메모리 캐싱 |
| PGM 로드 | 2-5초 | Pandas + NumPy 배열 변환 |
| 담보 매핑 체크 | 3-10초 | NumPy 벡터 연산 |
| **약관 생성 (핵심)** | **30초-2분** | ScreenUpdating Off |
| 태그 처리 | 담보당 0.5-1초 | Word Find/Replace |

### 성능 최적화

```python
# Pandas 기반 대용량 데이터 로드 (VBA 대비 10-50x 빠름)
self.data = DataLoader()
self.data.load_config_excel(file_path)  # Bulk load

# NumPy 배열 기반 데이터 접근 (나노초 수준)
arr_담보매핑 = self.data.arr_담보매핑
value = arr_담보매핑[row, col]  # Direct array access

# Word ScreenUpdating 비활성화
self.word.start_app(visible=False)
self.word.enable_screen_updating(False)
```

### 메모리 사용량

| 데이터 | 예상 메모리 |
|--------|------------|
| PGM 파일 (5000행) | 50-100 MB |
| 담보매핑 CSV (2000행) | 5-10 MB |
| Word 문서 | 20-50 MB |
| **총 예상** | **100-200 MB** |

---

## ⚠️ 우려되는 오류 사항

### 1. 파일 관련 오류

| 오류 | 원인 | 해결 방법 |
|------|------|-----------|
| `FileNotFoundError` | 경로 설정 오류 | Main 시트 경로 확인 |
| 인코딩 오류 | CSV 파일 인코딩 불일치 | UTF-8-sig로 저장 |
| Excel 열기 실패 | 파일 사용 중 | 다른 프로그램에서 닫기 |

### 2. Word COM 관련 오류

| 오류 | 원인 | 해결 방법 |
|------|------|-----------|
| `win32com.client` 오류 | Word 미설치 | MS Word 설치 필요 |
| 문서 열기 실패 | 손상된 docx | 파일 복구/재생성 |
| ScreenUpdating 오류 | Word 비정상 종료 | 작업관리자에서 WINWORD.EXE 종료 |

### 3. 태그 처리 오류

| 오류 | 원인 | 해결 방법 |
|------|------|-----------|
| 태그 미치환 | 참조시트에 정의 없음 | 참조.csv에 추가 |
| 잘못된 치환 | 적용구분 오류 | 참조.csv 검토 |
| 출력조정 오류 | 태그 쌍 불일치 | Base 파일 태그 확인 |

### 4. 데이터 관련 오류

| 오류 | 원인 | 해결 방법 |
|------|------|-----------|
| 대표담보코드 없음 | 담보매핑 CSV 누락 | CSV에 매핑 추가 |
| PGM 컬럼 인식 실패 | 헤더명 변경 | `_find_column_locations()` 수정 |
| IndexError | 배열 범위 초과 | 데이터 정합성 확인 |

### 5. 성능 관련 주의

```
⚠️ 주의사항
- Word 문서 작업 시 다른 Word 인스턴스 닫기 권장
- 대용량 PGM(10000행+) 처리 시 메모리 부족 가능
- VPN/네트워크 드라이브 경로 사용 시 느려질 수 있음
```

---

## 🛠️ 설치 및 실행

### 요구사항

```
Python 3.9+
Microsoft Word (COM 자동화용)
Microsoft Excel (데이터 로드용)
```

### 패키지 설치

```bash
pip install -r requirements.txt
```

### 실행

```bash
python main.py
```

---

## 📁 프로젝트 구조

```
Insurance_Terms_AutoGen/
├── main.py                 # GUI 메인 애플리케이션
├── requirements.txt        # Python 패키지 목록
├── data/
│   ├── 담보매핑.csv          # 담보코드 매핑 테이블
│   └── 참조.csv              # 태그 치환 문구 정의
├── templates/
│   └── 입력템플릿.xlsx       # 사용자 입력 템플릿
└── src/
    ├── csv_loader.py       # CSV 파일 로더
    ├── data_loader.py      # Excel 데이터 로더 (Pandas)
    ├── mapping_check.py    # 담보 매핑 체크 모듈
    ├── mod_appendix.py     # 별표 수정 모듈
    ├── print_dambo.py      # 약관 생성 핵심 모듈
    ├── tag_processor.py    # 태그 처리 모듈
    ├── word_utils.py       # Word COM 자동화 유틸
    ├── file_utils.py       # 파일 유틸리티
    ├── public_functions.py # 공용 함수
    └── template_generator.py # 템플릿 생성기
```

---


*Last Updated: 2026-02-03*
