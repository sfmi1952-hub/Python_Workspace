Phase 1.   
             rule_prompt = f"""
                **Role**: 보험 약관 분석 전문가 및 진단 코딩 전략 수립가.
                
                **Goal**: 
                제공된 참조 문서(약관 및 담보 테이블)와 진단코드 매핑테이블(Code Mapping Table)을 분석하여, 향후 Phase 2에서 **'담보명'과 '세부담보템플릿명'으로부터 정확한 '진단코드(분류번호)'를 도출할 수 있도록 돕는 추론 로직(Inference Logic)**을 추출하세요.
                
                **Reference Context**:
                - **Code Mapping Table (Reference)**:
                {code_mapping_csv}
                
                **Instructions**:
                - 단순히 내용을 요약하지 말고, **"이 담보의 진단 범위를 약관에서 어떻게 식별하고, 매핑 테이블의 어떤 코드와 연결해야 하는가?"**에 집중하세요.
                - 특히 약관 본문에 **'별표(Appendix)'** 혹은 **'부속서'**를 참조하라는 안내가 있는지 확인하고, 문서 뒷부분에 위치할 수 있는 해당 별표의 진단 정의(KCD 기호 등)를 찾아 로직에 포함하세요.
                - 약관에 명시된 질병 기호(KCD 등)나 정의 문구가 매핑 테이블의 '분류번호'와 어떻게 매칭되는지 패턴을 분석하세요.
                
                **Output Requirements (최대한 자세히 기술하세요)**:
                1. **담보별 진단 정의 분석 (Diagnosis Definition Patterns)**:
                   - 해당 세부담보템플릿이 보장하는 질병의 약관상 정의 및 핵심 키워드.
                   - (중요) 관련 '별표' 번호 및 해당 별표에 명시된 주요 KCD 코드 범위.
                2. **코드 매핑 로직 (Code Mapping Strategy)**:
                   - 약관상 정의된 질병 범위가 매핑 테이블의 어느 '분류번호' 범위에 해당하는지 기술.
                   - 예: "약관에서 정의한 '암'의 범위(C00~C97) -> 매핑 테이블상 '일반암' 분류번호(0A1)로 매핑"
                3. **포함/제외 세부 조건 (Inclusion/Exclusion Rules)**:
                   - 특정 코드 제외 혹은 특정 상태(갱신형 등)에 따른 코드 변형 규칙.
                4. **위치 및 문맥 단서 (Context Clues)**:
                   - 진단 정의가 주로 등장하는 조항 위치나 문서 내 표현 방식.
                """

Phase 2.
            prompt = f"""
            **Task**: 제공된 '담보명'과 '세부담보템플릿명'을 검토하고, 타겟 약관과 매핑 테이블을 바탕으로 정확한 **'진단코드(분류번호)'**를 추론하세요.

            **Input Benefit List**:
            {all_items_str}
            
            **Code Mapping Table (Current Reference)**:
            {code_mapping_csv}
            
            **Mapping Rules (참조 문서에서 추출한 추론 가이드라인 - 필독)**:
            {mapping_logic_text}
            
            **Instructions**:
            1. 입력된 '담보명'과 '세부담보템플릿명' 쌍을 순서대로 분석하세요.
            2. **약관 내 '별표(Appendix)' 우선 참조**: 약관 본문에서 특정 진단에 대해 '별표'를 참조하라고 되어 있다면, 해당 별표 페이지를 찾아 그 안의 질병 기호(KCD)를 최우선 근거로 삼으세요.
            3. **외부 지식 활용(Search Fallback)**: 만약 타겟 약관 내에서 직접적인 KCD 코드나 별표 정보를 찾을 수 없는 경우, 해당 담보명에 대한 **표준 KCD(한국표준질병사인분류) 지식**을 활용(검색 결과로 간주)하여 가장 타당한 범위를 도출하고, 이를 매핑 테이블의 '분류번호'와 매칭하세요.
            4. **input_template_name**: 입력 목록에 있는 '세부담보템플릿명'을 그대로 반환하세요.
            5. **inferred_code (추론된 진단코드)**:
               - 타겟 약관(특히 별표) 및 외부 KCD 정보를 활용하여 가장 적절한 **'분류번호'**를 선택하세요.
               - 매칭되는 코드가 명확하지 않은 경우, 가장 근접한 분류를 선택하거나 빈칸("")으로 두세요.
            6. **ref_sentence (근거 문장)**:
               - 약관 또는 별표에서 찾은 **진단 정의 문장 원문**을 그대로 기입하세요.
               - 외부 지식을 활용한 경우 "[외부 지식: KCD 분류 기준 상 ...에 해당함]" 형식으로 기입하세요.
               - 문장 뒤에 **[선정 이유]**를 덧붙여주세요.
            7. **ref_page**: 해당 내용이 위치한 타겟 약관의 페이지 번호를 숫자로 기입하세요. (외부 지식인 경우 '0' 기입)
            
            **Output JSON**:
            [
              {{
                "benefit_name": "입력된 담보명",
                "template_name": "입력된 세부담보템플릿명",
                "inferred_code": "분류번호 (예: 0A1)", 
                "ref_page": "페이지번호",
                "ref_sentence": "문장 원문 [선정 이유]"
              }}
            ]
            """
            